<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ DeFi Mathematics: AMMs & Liquidity</title>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 50%, #0369a1 100%);
            color: #ffffff;
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #f0f9ff;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .intro {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #06b6d4;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 30px 0;
        }
        
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(240, 249, 255, 0.3);
        }
        
        .amm-panel {
            background: rgba(6, 182, 212, 0.1);
            border: 2px solid #06b6d4;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .liquidity-pool {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid #22c55e;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }
        
        .pool-visualization {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .token-reserve {
            text-align: center;
            padding: 20px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            min-width: 120px;
        }
        
        .token-reserve.token-a {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
        }
        
        .token-reserve.token-b {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
        }
        
        .pool-connector {
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, #22c55e, #ef4444);
            position: relative;
        }
        
        .pool-connector::after {
            content: '‚ü∑';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: #06b6d4;
        }
        
        .control-group {
            margin: 15px 0;
        }
        
        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #e2e8f0;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #4a5568;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            box-sizing: border-box;
        }
        
        .btn {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-swap {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            width: 100%;
        }
        
        .btn-add-liquidity {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            width: 100%;
        }
        
        .btn-remove-liquidity {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            width: 100%;
        }
        
        .btn-calculate {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            width: 100%;
        }
        
        .math-formula {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-family: 'Times New Roman', serif;
        }
        
        .calculation-result {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid #06b6d4;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .price-chart {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            height: 300px;
        }
        
        .arbitrage-panel {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .yield-farming {
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid #8b5cf6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #06b6d4;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 10px 0;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #06b6d4, #22c55e);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .slippage-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .slippage-low {
            color: #22c55e;
        }
        
        .slippage-medium {
            color: #f59e0b;
        }
        
        .slippage-high {
            color: #ef4444;
        }
        
        @media (max-width: 768px) {
            .demo-grid, .three-column {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .pool-visualization {
                flex-direction: column;
                gap: 15px;
            }
            
            .pool-connector {
                width: 3px;
                height: 50px;
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ DeFi Mathematics: AMMs & Liquidity</h1>
        
        <div class="intro">
            <h2>Decentralized Finance Mathematics</h2>
            <p><strong>DeFi (Decentralized Finance)</strong> revolutionizes traditional finance through mathematical algorithms. <strong>Automated Market Makers (AMMs)</strong> use mathematical formulas to price assets and provide liquidity without traditional order books.</p>
            <p>Key concepts include: <strong>Constant Product Formula</strong>, <strong>Impermanent Loss</strong>, <strong>Slippage</strong>, and <strong>Yield Farming Mathematics</strong>.</p>
        </div>
        
        <div class="math-formula">
            <h3>üßÆ Core AMM Mathematics</h3>
            <p><strong>Constant Product Formula:</strong> x √ó y = k (Uniswap V2)</p>
            <p><strong>Constant Sum Formula:</strong> x + y = k (StableSwap)</p>
            <p><strong>Constant Mean Formula:</strong> x^w‚ÇÅ √ó y^w‚ÇÇ = k (Balancer)</p>
            <p><strong>Price Impact:</strong> Œîp = (Œîx √ó y) / ((x + Œîx) √ó x)</p>
            <p><strong>Impermanent Loss:</strong> IL = 2‚àö(price_ratio) / (1 + price_ratio) - 1</p>
        </div>
        
        <div class="demo-grid">
            <div class="amm-panel">
                <h3>üîÑ Automated Market Maker</h3>
                
                <div class="control-group">
                    <label>AMM Type:</label>
                    <select id="ammType" onchange="updateAMMFormula()">
                        <option value="constant-product">Constant Product (Uniswap)</option>
                        <option value="constant-sum">Constant Sum (Curve)</option>
                        <option value="constant-mean">Constant Mean (Balancer)</option>
                        <option value="hybrid">Hybrid (Curve V2)</option>
                    </select>
                </div>
                
                <div class="liquidity-pool">
                    <h4>üíß Liquidity Pool</h4>
                    <div class="pool-visualization">
                        <div class="token-reserve token-a">
                            <div><strong>Token A (ETH)</strong></div>
                            <div id="reserveA">1000</div>
                            <div>Reserve</div>
                        </div>
                        <div class="pool-connector"></div>
                        <div class="token-reserve token-b">
                            <div><strong>Token B (USDC)</strong></div>
                            <div id="reserveB">2000000</div>
                            <div>Reserve</div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div><strong>K Value</strong></div>
                            <div id="kValue">2,000,000,000</div>
                        </div>
                        <div class="stat-card">
                            <div><strong>Price (A/B)</strong></div>
                            <div id="priceAB">2000 USDC</div>
                        </div>
                        <div class="stat-card">
                            <div><strong>TVL</strong></div>
                            <div id="tvl">$4,000,000</div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Initial Reserve A:</label>
                    <input type="number" id="initialA" value="1000" onchange="updatePool()">
                </div>
                
                <div class="control-group">
                    <label>Initial Reserve B:</label>
                    <input type="number" id="initialB" value="2000000" onchange="updatePool()">
                </div>
                
                <button class="btn btn-calculate" onclick="updatePool()">üìä Update Pool</button>
            </div>
            
            <div class="control-panel">
                <h3>üîÑ Token Swap Simulator</h3>
                
                <div class="control-group">
                    <label>Swap Direction:</label>
                    <select id="swapDirection">
                        <option value="a-to-b">Token A ‚Üí Token B</option>
                        <option value="b-to-a">Token B ‚Üí Token A</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Input Amount:</label>
                    <input type="number" id="swapInput" value="10" oninput="calculateSwap()">
                </div>
                
                <div id="swapResult" class="calculation-result">
                    <h4>üìà Swap Analysis</h4>
                    <div id="swapDetails">Enter amount to see swap details</div>
                </div>
                
                <div class="slippage-indicator">
                    <span>Slippage:</span>
                    <span id="slippageValue" class="slippage-low">0.1%</span>
                </div>
                
                <button class="btn btn-swap" onclick="executeSwap()">üîÑ Execute Swap</button>
                
                <div id="priceImpact" class="warning" style="display: none;">
                    <h4>‚ö†Ô∏è Price Impact Warning</h4>
                    <div id="impactDetails"></div>
                </div>
            </div>
        </div>
        
        <div class="three-column">
            <div class="control-panel">
                <h3>‚ûï Add Liquidity</h3>
                
                <div class="control-group">
                    <label>Token A Amount:</label>
                    <input type="number" id="addAmountA" value="100" oninput="calculateLPTokens()">
                </div>
                
                <div class="control-group">
                    <label>Token B Amount:</label>
                    <input type="number" id="addAmountB" value="200000" oninput="calculateLPTokens()">
                </div>
                
                <div id="lpResult" class="calculation-result">
                    <h4>ü™ô LP Token Calculation</h4>
                    <div id="lpDetails">Balance amounts to see LP tokens</div>
                </div>
                
                <button class="btn btn-add-liquidity" onclick="addLiquidity()">‚ûï Add Liquidity</button>
                
                <div class="control-group" style="margin-top: 20px;">
                    <label>LP Tokens to Remove:</label>
                    <input type="number" id="removeLPAmount" value="0" oninput="calculateRemoval()">
                </div>
                
                <button class="btn btn-remove-liquidity" onclick="removeLiquidity()">‚ûñ Remove Liquidity</button>
            </div>
            
            <div class="yield-farming">
                <h3>üåæ Yield Farming Calculator</h3>
                
                <div class="control-group">
                    <label>Staked LP Tokens:</label>
                    <input type="number" id="stakedLP" value="1000" oninput="calculateYield()">
                </div>
                
                <div class="control-group">
                    <label>APY (%):</label>
                    <input type="number" id="farmingAPY" value="150" oninput="calculateYield()">
                </div>
                
                <div class="control-group">
                    <label>Time Period (days):</label>
                    <input type="number" id="farmingDays" value="365" oninput="calculateYield()">
                </div>
                
                <div id="yieldResult" class="calculation-result">
                    <h4>üìà Yield Projection</h4>
                    <div id="yieldDetails">
                        <p><strong>Daily Yield:</strong> <span id="dailyYield">4.11</span> tokens</p>
                        <p><strong>Monthly Yield:</strong> <span id="monthlyYield">125</span> tokens</p>
                        <p><strong>Annual Yield:</strong> <span id="annualYield">1500</span> tokens</p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div><strong>Total Value</strong></div>
                        <div id="totalStakedValue">$50,000</div>
                    </div>
                    <div class="stat-card">
                        <div><strong>Daily Rewards</strong></div>
                        <div id="dailyRewardValue">$205</div>
                    </div>
                </div>
            </div>
            
            <div class="arbitrage-panel">
                <h3>‚ö° Arbitrage Opportunities</h3>
                
                <div class="control-group">
                    <label>External Price (Token A):</label>
                    <input type="number" id="externalPrice" value="2100" oninput="calculateArbitrage()">
                </div>
                
                <div id="arbitrageResult" class="calculation-result">
                    <h4>üí∞ Arbitrage Analysis</h4>
                    <div id="arbitrageDetails">
                        <p><strong>Pool Price:</strong> <span id="poolPrice">2000</span> USDC</p>
                        <p><strong>External Price:</strong> <span id="extPrice">2100</span> USDC</p>
                        <p><strong>Price Difference:</strong> <span id="priceDiff">5%</span></p>
                        <p><strong>Profit Opportunity:</strong> <span id="profitOpp">Buy from pool, sell external</span></p>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Arbitrage Amount:</label>
                    <input type="number" id="arbAmount" value="50" oninput="calculateArbProfit()">
                </div>
                
                <div id="arbProfitResult" class="calculation-result">
                    <h4>üìä Expected Profit</h4>
                    <div id="arbProfitDetails">Enter amount to calculate profit</div>
                </div>
                
                <button class="btn" onclick="executeArbitrage()" style="width: 100%;">‚ö° Execute Arbitrage</button>
            </div>
        </div>
        
        <div class="demo-grid">
            <div class="control-panel">
                <h3>üìâ Impermanent Loss Calculator</h3>
                
                <div class="control-group">
                    <label>Initial Price Ratio:</label>
                    <input type="number" id="initialRatio" value="1" step="0.01" oninput="calculateImpermanentLoss()">
                </div>
                
                <div class="control-group">
                    <label>Current Price Ratio:</label>
                    <input type="number" id="currentRatio" value="1.5" step="0.01" oninput="calculateImpermanentLoss()">
                </div>
                
                <div id="ilResult" class="calculation-result">
                    <h4>üìä Impermanent Loss Analysis</h4>
                    <div id="ilDetails"></div>
                </div>
                
                <div class="price-chart">
                    <canvas id="ilChart"></canvas>
                </div>
            </div>
            
            <div class="control-panel">
                <h3>üìà Price Impact Visualization</h3>
                
                <div class="control-group">
                    <label>Trade Size (% of pool):</label>
                    <input type="range" id="tradeSizeSlider" min="0.1" max="50" step="0.1" value="5" oninput="updatePriceImpact()">
                    <span id="tradeSizeDisplay">5%</span>
                </div>
                
                <div class="price-chart">
                    <canvas id="priceImpactChart"></canvas>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div><strong>Price Impact</strong></div>
                        <div id="currentPriceImpact">2.5%</div>
                    </div>
                    <div class="stat-card">
                        <div><strong>Effective Price</strong></div>
                        <div id="effectivePrice">2050 USDC</div>
                    </div>
                    <div class="stat-card">
                        <div><strong>Slippage</strong></div>
                        <div id="currentSlippage">2.5%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="math-formula">
            <h3>üìä Advanced DeFi Formulas</h3>
            <p><strong>Weighted Constant Product:</strong> ‚àè(x_i^w_i) = k</p>
            <p><strong>Curve StableSwap:</strong> An^n ‚àëx_i + D = ADn^n + D^(n+1)/(n^n ‚àèx_i)</p>
            <p><strong>Capital Efficiency:</strong> Œ∑ = (Virtual_Liquidity / Actual_Liquidity) √ó 100%</p>
            <p><strong>Fee APY:</strong> APY = (daily_volume √ó fee_rate √ó 365) / TVL</p>
        </div>
    </div>

    <script>
        // Global state
        let poolState = {
            reserveA: 1000,
            reserveB: 2000000,
            k: 2000000000,
            totalSupply: Math.sqrt(1000 * 2000000),
            ammType: 'constant-product'
        };
        
        let priceHistory = [];
        let ilChart = null;
        let priceImpactChart = null;
        
        // Initialize
        updatePool();
        calculateSwap();
        calculateYield();
        calculateArbitrage();
        calculateImpermanentLoss();
        initializeCharts();
        
        function updateAMMFormula() {
            const ammType = document.getElementById('ammType').value;
            poolState.ammType = ammType;
            updatePool();
        }
        
        function updatePool() {
            const reserveA = parseFloat(document.getElementById('initialA').value);
            const reserveB = parseFloat(document.getElementById('initialB').value);
            
            poolState.reserveA = reserveA;
            poolState.reserveB = reserveB;
            
            if (poolState.ammType === 'constant-product') {
                poolState.k = reserveA * reserveB;
            } else if (poolState.ammType === 'constant-sum') {
                poolState.k = reserveA + reserveB;
            }
            
            poolState.totalSupply = Math.sqrt(reserveA * reserveB);
            
            updatePoolDisplay();
            calculateSwap();
            calculateLPTokens();
        }
        
        function updatePoolDisplay() {
            document.getElementById('reserveA').textContent = poolState.reserveA.toFixed(2);
            document.getElementById('reserveB').textContent = poolState.reserveB.toLocaleString();
            document.getElementById('kValue').textContent = poolState.k.toLocaleString();
            
            const priceAB = poolState.reserveB / poolState.reserveA;
            document.getElementById('priceAB').textContent = priceAB.toFixed(0) + ' USDC';
            
            const tvl = (poolState.reserveA * priceAB + poolState.reserveB);
            document.getElementById('tvl').textContent = '$' + tvl.toLocaleString();
        }
        
        function calculateSwap() {
            const inputAmount = parseFloat(document.getElementById('swapInput').value) || 0;
            const direction = document.getElementById('swapDirection').value;
            
            if (inputAmount <= 0) {
                document.getElementById('swapDetails').textContent = 'Enter amount to see swap details';
                return;
            }
            
            let outputAmount, priceImpact, newPriceAB;
            
            if (direction === 'a-to-b') {
                // Selling A for B
                if (poolState.ammType === 'constant-product') {
                    const newReserveA = poolState.reserveA + inputAmount;
                    const newReserveB = poolState.k / newReserveA;
                    outputAmount = poolState.reserveB - newReserveB;
                    newPriceAB = newReserveB / newReserveA;
                } else if (poolState.ammType === 'constant-sum') {
                    outputAmount = inputAmount; // 1:1 swap for constant sum
                    newPriceAB = 1;
                }
            } else {
                // Selling B for A
                if (poolState.ammType === 'constant-product') {
                    const newReserveB = poolState.reserveB + inputAmount;
                    const newReserveA = poolState.k / newReserveB;
                    outputAmount = poolState.reserveA - newReserveA;
                    newPriceAB = newReserveB / newReserveA;
                } else if (poolState.ammType === 'constant-sum') {
                    outputAmount = inputAmount; // 1:1 swap for constant sum
                    newPriceAB = 1;
                }
            }
            
            const currentPrice = poolState.reserveB / poolState.reserveA;
            priceImpact = Math.abs((newPriceAB - currentPrice) / currentPrice) * 100;
            
            const slippage = priceImpact;
            updateSlippageDisplay(slippage);
            
            document.getElementById('swapDetails').innerHTML = `
                <p><strong>Output Amount:</strong> ${outputAmount.toFixed(6)}</p>
                <p><strong>Exchange Rate:</strong> 1 ${direction === 'a-to-b' ? 'A' : 'B'} = ${(outputAmount/inputAmount).toFixed(6)} ${direction === 'a-to-b' ? 'B' : 'A'}</p>
                <p><strong>Price Impact:</strong> ${priceImpact.toFixed(3)}%</p>
                <p><strong>New Price:</strong> ${newPriceAB.toFixed(2)} USDC per ETH</p>
            `;
            
            if (priceImpact > 5) {
                document.getElementById('priceImpact').style.display = 'block';
                document.getElementById('impactDetails').innerHTML = `
                    High price impact of ${priceImpact.toFixed(2)}%! Consider reducing trade size.
                `;
            } else {
                document.getElementById('priceImpact').style.display = 'none';
            }
        }
        
        function updateSlippageDisplay(slippage) {
            const slippageElement = document.getElementById('slippageValue');
            slippageElement.textContent = slippage.toFixed(2) + '%';
            
            if (slippage < 1) {
                slippageElement.className = 'slippage-low';
            } else if (slippage < 5) {
                slippageElement.className = 'slippage-medium';
            } else {
                slippageElement.className = 'slippage-high';
            }
        }
        
        function executeSwap() {
            const inputAmount = parseFloat(document.getElementById('swapInput').value) || 0;
            const direction = document.getElementById('swapDirection').value;
            
            if (inputAmount <= 0) {
                alert('Please enter a valid swap amount!');
                return;
            }
            
            // Update pool state
            if (direction === 'a-to-b') {
                const newReserveA = poolState.reserveA + inputAmount;
                const newReserveB = poolState.k / newReserveA;
                poolState.reserveA = newReserveA;
                poolState.reserveB = newReserveB;
            } else {
                const newReserveB = poolState.reserveB + inputAmount;
                const newReserveA = poolState.k / newReserveB;
                poolState.reserveA = newReserveA;
                poolState.reserveB = newReserveB;
            }
            
            updatePoolDisplay();
            addPriceToHistory();
            document.getElementById('swapInput').value = '';
            calculateSwap();
            
            alert('Swap executed successfully!');
        }
        
        function calculateLPTokens() {
            const amountA = parseFloat(document.getElementById('addAmountA').value) || 0;
            const amountB = parseFloat(document.getElementById('addAmountB').value) || 0;
            
            if (amountA <= 0 || amountB <= 0) {
                document.getElementById('lpDetails').textContent = 'Balance amounts to see LP tokens';
                return;
            }
            
            // Check if amounts are proportional
            const currentRatio = poolState.reserveB / poolState.reserveA;
            const providedRatio = amountB / amountA;
            const ratioDeviation = Math.abs((providedRatio - currentRatio) / currentRatio) * 100;
            
            // Calculate LP tokens
            const lpTokens = Math.min(
                (amountA / poolState.reserveA) * poolState.totalSupply,
                (amountB / poolState.reserveB) * poolState.totalSupply
            );
            
            const poolShare = (lpTokens / poolState.totalSupply) * 100;
            
            document.getElementById('lpDetails').innerHTML = `
                <p><strong>LP Tokens:</strong> ${lpTokens.toFixed(6)}</p>
                <p><strong>Pool Share:</strong> ${poolShare.toFixed(4)}%</p>
                <p><strong>Ratio Deviation:</strong> ${ratioDeviation.toFixed(2)}%</p>
                ${ratioDeviation > 1 ? '<p class="warning">‚ö†Ô∏è Amounts not proportional - excess will be refunded</p>' : ''}
            `;
        }
        
        function addLiquidity() {
            const amountA = parseFloat(document.getElementById('addAmountA').value) || 0;
            const amountB = parseFloat(document.getElementById('addAmountB').value) || 0;
            
            if (amountA <= 0 || amountB <= 0) {
                alert('Please enter valid amounts!');
                return;
            }
            
            // Add liquidity proportionally
            const ratioA = amountA / poolState.reserveA;
            const ratioB = amountB / poolState.reserveB;
            const ratio = Math.min(ratioA, ratioB);
            
            const actualAmountA = ratio * poolState.reserveA;
            const actualAmountB = ratio * poolState.reserveB;
            
            poolState.reserveA += actualAmountA;
            poolState.reserveB += actualAmountB;
            poolState.k = poolState.reserveA * poolState.reserveB;
            poolState.totalSupply *= (1 + ratio);
            
            updatePoolDisplay();
            calculateLPTokens();
            
            alert(`Liquidity added! Used ${actualAmountA.toFixed(6)} A and ${actualAmountB.toFixed(2)} B`);
        }
        
        function calculateRemoval() {
            const lpAmount = parseFloat(document.getElementById('removeLPAmount').value) || 0;
            
            if (lpAmount <= 0) return;
            
            const share = lpAmount / poolState.totalSupply;
            const amountA = share * poolState.reserveA;
            const amountB = share * poolState.reserveB;
            
            document.getElementById('lpDetails').innerHTML += `
                <hr>
                <p><strong>Withdrawal:</strong></p>
                <p>Token A: ${amountA.toFixed(6)}</p>
                <p>Token B: ${amountB.toFixed(2)}</p>
                <p>Share: ${(share * 100).toFixed(4)}%</p>
            `;
        }
        
        function removeLiquidity() {
            const lpAmount = parseFloat(document.getElementById('removeLPAmount').value) || 0;
            
            if (lpAmount <= 0 || lpAmount > poolState.totalSupply) {
                alert('Please enter a valid LP token amount!');
                return;
            }
            
            const share = lpAmount / poolState.totalSupply;
            const amountA = share * poolState.reserveA;
            const amountB = share * poolState.reserveB;
            
            poolState.reserveA -= amountA;
            poolState.reserveB -= amountB;
            poolState.k = poolState.reserveA * poolState.reserveB;
            poolState.totalSupply -= lpAmount;
            
            updatePoolDisplay();
            calculateLPTokens();
            
            alert(`Liquidity removed! Received ${amountA.toFixed(6)} A and ${amountB.toFixed(2)} B`);
        }
        
        function calculateYield() {
            const stakedLP = parseFloat(document.getElementById('stakedLP').value) || 0;
            const apy = parseFloat(document.getElementById('farmingAPY').value) || 0;
            const days = parseFloat(document.getElementById('farmingDays').value) || 0;
            
            const dailyRate = apy / 365 / 100;
            const dailyYield = stakedLP * dailyRate;
            const monthlyYield = dailyYield * 30;
            const annualYield = stakedLP * (apy / 100);
            
            document.getElementById('dailyYield').textContent = dailyYield.toFixed(2);
            document.getElementById('monthlyYield').textContent = monthlyYield.toFixed(0);
            document.getElementById('annualYield').textContent = annualYield.toFixed(0);
            
            const tokenPrice = 50; // Assume $50 per token
            document.getElementById('totalStakedValue').textContent = '$' + (stakedLP * tokenPrice).toLocaleString();
            document.getElementById('dailyRewardValue').textContent = '$' + (dailyYield * tokenPrice).toFixed(0);
        }
        
        function calculateArbitrage() {
            const externalPrice = parseFloat(document.getElementById('externalPrice').value) || 0;
            const poolPrice = poolState.reserveB / poolState.reserveA;
            
            const priceDiff = ((externalPrice - poolPrice) / poolPrice) * 100;
            
            document.getElementById('poolPrice').textContent = poolPrice.toFixed(0);
            document.getElementById('extPrice').textContent = externalPrice.toFixed(0);
            document.getElementById('priceDiff').textContent = Math.abs(priceDiff).toFixed(2) + '%';
            
            if (priceDiff > 0) {
                document.getElementById('profitOpp').textContent = 'Buy from pool, sell external';
            } else {
                document.getElementById('profitOpp').textContent = 'Buy external, sell to pool';
            }
        }
        
        function calculateArbProfit() {
            const arbAmount = parseFloat(document.getElementById('arbAmount').value) || 0;
            const externalPrice = parseFloat(document.getElementById('externalPrice').value) || 0;
            const poolPrice = poolState.reserveB / poolState.reserveA;
            
            const profit = arbAmount * Math.abs(externalPrice - poolPrice);
            const roi = (profit / (arbAmount * Math.min(externalPrice, poolPrice))) * 100;
            
            document.getElementById('arbProfitDetails').innerHTML = `
                <p><strong>Expected Profit:</strong> $${profit.toFixed(2)}</p>
                <p><strong>ROI:</strong> ${roi.toFixed(2)}%</p>
                <p><strong>Capital Required:</strong> $${(arbAmount * Math.min(externalPrice, poolPrice)).toFixed(2)}</p>
            `;
        }
        
        function executeArbitrage() {
            alert('Arbitrage opportunity executed! (Simulation)');
        }
        
        function calculateImpermanentLoss() {
            const initialRatio = parseFloat(document.getElementById('initialRatio').value) || 1;
            const currentRatio = parseFloat(document.getElementById('currentRatio').value) || 1;
            
            const priceRatio = currentRatio / initialRatio;
            const il = (2 * Math.sqrt(priceRatio)) / (1 + priceRatio) - 1;
            const ilPercentage = il * 100;
            
            const holdValue = (1 + priceRatio) / 2; // Value if just holding
            const lpValue = Math.sqrt(priceRatio); // Value as LP
            const realIL = ((holdValue - lpValue) / holdValue) * 100;
            
            document.getElementById('ilDetails').innerHTML = `
                <p><strong>Price Change:</strong> ${((priceRatio - 1) * 100).toFixed(2)}%</p>
                <p><strong>Impermanent Loss:</strong> ${realIL.toFixed(2)}%</p>
                <p><strong>LP Value vs Hold:</strong> ${((lpValue / holdValue - 1) * 100).toFixed(2)}%</p>
                <p><strong>Break-even Fee APY:</strong> ${(realIL * 365 / 30).toFixed(1)}%</p>
            `;
            
            updateILChart(priceRatio, realIL);
        }
        
        function updatePriceImpact() {
            const tradeSize = parseFloat(document.getElementById('tradeSizeSlider').value);
            document.getElementById('tradeSizeDisplay').textContent = tradeSize + '%';
            
            const tradeAmount = (tradeSize / 100) * poolState.reserveA;
            const newReserveA = poolState.reserveA + tradeAmount;
            const newReserveB = poolState.k / newReserveA;
            
            const oldPrice = poolState.reserveB / poolState.reserveA;
            const newPrice = newReserveB / newReserveA;
            const priceImpact = ((oldPrice - newPrice) / oldPrice) * 100;
            
            document.getElementById('currentPriceImpact').textContent = priceImpact.toFixed(2) + '%';
            document.getElementById('effectivePrice').textContent = newPrice.toFixed(0) + ' USDC';
            document.getElementById('currentSlippage').textContent = priceImpact.toFixed(2) + '%';
            
            updatePriceImpactChart(tradeSize, priceImpact);
        }
        
        function addPriceToHistory() {
            const price = poolState.reserveB / poolState.reserveA;
            priceHistory.push({
                timestamp: Date.now(),
                price: price
            });
            
            if (priceHistory.length > 100) {
                priceHistory.shift();
            }
        }
        
        function initializeCharts() {
            // Initialize IL Chart
            const ilCtx = document.getElementById('ilChart').getContext('2d');
            ilChart = new Chart(ilCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Impermanent Loss %',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Impermanent Loss %'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Price Ratio'
                            }
                        }
                    }
                }
            });
            
            // Initialize Price Impact Chart
            const piCtx = document.getElementById('priceImpactChart').getContext('2d');
            priceImpactChart = new Chart(piCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price Impact %',
                        data: [],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Price Impact %'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Trade Size % of Pool'
                            }
                        }
                    }
                }
            });
            
            // Generate initial chart data
            generateILData();
            generatePriceImpactData();
        }
        
        function generateILData() {
            const data = [];
            const labels = [];
            
            for (let ratio = 0.1; ratio <= 10; ratio += 0.1) {
                const il = ((2 * Math.sqrt(ratio)) / (1 + ratio) - 1) * 100;
                const realIL = ((1 + ratio) / 2 - Math.sqrt(ratio)) / ((1 + ratio) / 2) * 100;
                data.push(Math.abs(realIL));
                labels.push(ratio.toFixed(1));
            }
            
            ilChart.data.labels = labels;
            ilChart.data.datasets[0].data = data;
            ilChart.update();
        }
        
        function generatePriceImpactData() {
            const data = [];
            const labels = [];
            
            for (let size = 0.1; size <= 50; size += 0.5) {
                const tradeAmount = (size / 100) * poolState.reserveA;
                const newReserveA = poolState.reserveA + tradeAmount;
                const newReserveB = poolState.k / newReserveA;
                
                const oldPrice = poolState.reserveB / poolState.reserveA;
                const newPrice = newReserveB / newReserveA;
                const priceImpact = ((oldPrice - newPrice) / oldPrice) * 100;
                
                data.push(priceImpact);
                labels.push(size.toFixed(1));
            }
            
            priceImpactChart.data.labels = labels;
            priceImpactChart.data.datasets[0].data = data;
            priceImpactChart.update();
        }
        
        function updateILChart(priceRatio, il) {
            // Update chart with current position
            // Implementation depends on specific requirements
        }
        
        function updatePriceImpactChart(tradeSize, impact) {
            // Update chart with current position
            // Implementation depends on specific requirements
        }
        
        // Initialize MathJax when page loads
        window.onload = function() {
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        };
    </script>
</body>
</html>
